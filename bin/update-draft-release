#!/usr/bin/env ruby
# encoding: utf-8

require 'update_draft_release'

if ARGV.empty? || ARGV[0].empty?
  puts 'Missing: repository name'
  exit
end

repo = nil
options = {}

# Acceptable options:
#
# --in-gamma
# --in-assignment
# --in-top-level/--at-top-level
# --at-the-end
# --create-heading
# --open-url
# --skip-confirmation
#
ARGV.each do |arg|
  case arg
  when /\A--(in|on|at)-(\w+)\Z/
    puts "Assuming '#{arg}' is a Singlish way of saying '--in-#{$2}'" if $1 != 'in'
    options[:insert_at] = $2.gsub('_', ' ')
  when '--in-top-level', '--at-top-level'
    options[:insert_at_top_level] = true
  when '--at-the-end'
    options[:insert_at_the_end] = true
  when '--create-heading'
    options[:create_heading] = true
  when '--open-url'
    options[:open_url_after_update] = true
  when '--skip-confirmation'
    options[:skip_confirmation] = true
  when /\A\w+\/\w+\Z/
    repo = arg
  when /\A--([-\w]+)\Z/
    puts "Invalid option: --#{$1}"
    exit
  else
    puts "Hah? What's '#{arg}'? Should be 'user/repo' format lah."
    exit
  end
end

if repo.nil?
  puts 'Missing: repo why you no repo'
  exit
end

begin
  runner = UpdateDraftRelease::Runner.new(repo, options)
  runner.update_draft_release
rescue Exception => e
  puts e.message
end
